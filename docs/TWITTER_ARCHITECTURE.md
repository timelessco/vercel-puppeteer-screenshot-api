# Twitter Media Extraction - Architecture Diagram

## ğŸ¯ High-Level Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        User Request                              â”‚
â”‚          (Twitter URL + extractMediaUrls: true)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Twitter Media Extraction Module                     â”‚
â”‚                  (API-First Approach)                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Strategy 1: Syndication API       â”‚
        â”‚  âš¡ Fast: ~200ms                   â”‚
        â”‚  âœ“ Success Rate: 85%               â”‚
        â”‚  âœ“ No Auth Required                â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                  Success? â”€â”€â”€â”€â”€â”€â”€â”€â”
                     â”‚             â”‚
                    YES            NO
                     â”‚             â”‚
                     â”‚             â–¼
                     â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                     â”‚   â”‚ Strategy 2: HTML Parsing   â”‚
                     â”‚   â”‚ ğŸ”¸ Medium: ~500ms          â”‚
                     â”‚   â”‚ âœ“ Success Rate: 60%        â”‚
                     â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚            â”‚
                     â”‚         Success?
                     â”‚            â”‚
                     â”‚           YES    NO
                     â”‚            â”‚     â”‚
                     â”‚            â”‚     â–¼
                     â”‚            â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                     â”‚            â”‚   â”‚ Strategy 3: oEmbed â”‚
                     â”‚            â”‚   â”‚ ğŸ”¸ Medium: ~300ms  â”‚
                     â”‚            â”‚   â”‚ âœ“ Success: 70%     â”‚
                     â”‚            â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚            â”‚            â”‚
                     â”‚            â”‚         Success?
                     â”‚            â”‚            â”‚
                     â”‚            â”‚           YES    NO
                     â”‚            â”‚            â”‚     â”‚
                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
                                  â”‚                   â”‚
                                  â–¼                   â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   Media Extracted   â”‚   â”‚ All Failed   â”‚
                    â”‚   âœ“ Videos          â”‚   â”‚ (Use Puppet) â”‚
                    â”‚   âœ“ Images          â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚   âœ“ GIFs            â”‚
                    â”‚   âœ“ Metadata        â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Continue with      â”‚
                    â”‚  Puppeteer for      â”‚
                    â”‚  Screenshot         â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   Return Result:    â”‚
                    â”‚   â€¢ Screenshot      â”‚
                    â”‚   â€¢ Media URLs      â”‚
                    â”‚   â€¢ Metadata        â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“¦ Module Structure

```
src/lib/twitter/
â”œâ”€â”€ index.ts                    # Public API exports
â”œâ”€â”€ types.ts                    # TypeScript definitions
â”œâ”€â”€ urlUtils.ts                 # URL parsing & validation
â”‚   â”œâ”€â”€ extractTweetId()
â”‚   â”œâ”€â”€ parseTwitterUrl()
â”‚   â”œâ”€â”€ isTweetUrl()
â”‚   â””â”€â”€ normalizeTwitterUrl()
â”œâ”€â”€ videoQuality.ts             # Quality selection logic
â”‚   â”œâ”€â”€ processVideoVariants()
â”‚   â”œâ”€â”€ selectBestVideo()
â”‚   â””â”€â”€ getVideoQualityStats()
â”œâ”€â”€ extractMediaUrls.ts         # Main extraction (Syndication API)
â”‚   â”œâ”€â”€ extractTwitterMediaUrls()
â”‚   â”œâ”€â”€ extractTwitterVideoUrls()
â”‚   â”œâ”€â”€ extractTwitterImageUrls()
â”‚   â””â”€â”€ extractBestTwitterVideoUrl()
â”œâ”€â”€ fallbackStrategies.ts       # Backup extraction methods
â”‚   â”œâ”€â”€ extractMediaFromHTML()
â”‚   â””â”€â”€ extractMediaFromOEmbed()
â””â”€â”€ extractWithFallback.ts      # Multi-strategy coordinator
    â”œâ”€â”€ extractTwitterMediaWithFallback()
    â””â”€â”€ hasTweetMedia()
```

## ğŸ”„ Data Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Tweet URL   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Extract Tweet ID â”‚ â† urlUtils.extractTweetId()
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Fetch from Syndication    â”‚ â† extractMediaUrls.fetchTweetSyndication()
â”‚ API                        â”‚
â”‚ cdn.syndication.twimg.com â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Parse Response        â”‚
â”‚ {                     â”‚
â”‚   mediaDetails: [     â”‚
â”‚     {                 â”‚
â”‚       type: "video",  â”‚
â”‚       video_info: {   â”‚
â”‚         variants: []  â”‚ â† Multiple quality options
â”‚       }               â”‚
â”‚     }                 â”‚
â”‚   ]                   â”‚
â”‚ }                     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Process Video Variants â”‚ â† videoQuality.processVideoVariants()
â”‚ â€¢ Filter MP4 only      â”‚
â”‚ â€¢ Assign quality label â”‚
â”‚ â€¢ Sort by bitrate      â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Select Best Video  â”‚ â† videoQuality.selectBestVideo()
â”‚ Based on Preferenceâ”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Return Result      â”‚
â”‚ {                  â”‚
â”‚   videos: [],      â”‚
â”‚   images: [],      â”‚
â”‚   gifs: [],        â”‚
â”‚   tweet: {}        â”‚
â”‚ }                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ¨ Integration Points

```
Existing Code                     New Twitter Module
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                     â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ app/try/route.ts    â”‚          â”‚ lib/twitter/             â”‚
â”‚                     â”‚          â”‚                          â”‚
â”‚ GET /api/screenshot â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ extractTwitterMedia      â”‚
â”‚                     â”‚          â”‚ WithFallback()           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                                 â–²
           â”‚                                 â”‚
           â–¼                                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚ getScreenshot()     â”‚                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
           â”‚                                 â”‚
           â–¼                                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚ withBrowser()       â”‚                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
           â”‚                                 â”‚
           â–¼                                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚ getTwitterScreenshot()  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ (Enhanced)              â”‚
â”‚                         â”‚
â”‚ â€¢ Extract media first   â”‚
â”‚ â€¢ Then take screenshot  â”‚
â”‚ â€¢ Return both           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“Š Performance Profile

```
Traditional Approach (Puppeteer Only):
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Launch Browser  â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“  1.5s
Navigate        â–“â–“â–“â–“â–“â–“â–“â–“             0.8s
Wait & Parse    â–“â–“â–“â–“â–“â–“               0.6s
Screenshot      â–“â–“â–“â–“                 0.4s
Close Browser   â–“â–“                   0.2s
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Total: ~3.5s

New Approach (API + Puppeteer):
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Extract Media   â–“               0.2s  â† New!
Launch Browser  â–“â–“â–“â–“â–“â–“â–“â–“â–“       1.5s
Navigate        â–“â–“â–“â–“â–“â–“           0.8s
Screenshot      â–“â–“â–“              0.4s
Close Browser   â–“                0.2s
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Total: ~3.1s + direct media URLs!

API-Only Approach (When no screenshot needed):
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Extract Media   â–“               0.2s
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Total: ~0.2s (17x faster!)
```

## ğŸ¯ Quality Selection Logic

```
Twitter Provides Multiple Variants:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

variant[0]: 2176000 bps (1280x720) â”€â”€â–º "high"
variant[1]: 832000 bps  (640x360)  â”€â”€â–º "medium"
variant[2]: 288000 bps  (320x180)  â”€â”€â–º "low"
variant[3]: m3u8 (HLS)             â”€â”€â–º filtered out

                 â”‚
                 â–¼
         Quality Selector
                 â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚            â”‚            â”‚
    â–¼            â–¼            â–¼
  high        medium         low
preference   preference   preference
    â”‚            â”‚            â”‚
    â–¼            â–¼            â–¼
Select       Select       Select
highest      middle       lowest
bitrate      bitrate      bitrate
    â”‚            â”‚            â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
         Return best match
        (with smart fallback)
```

## ğŸ”’ Type Safety Flow

```typescript
// Input
interface ExtractTwitterMediaOptions {
  url: string;
  logger: Logger;
  preferredQuality?: 'high' | 'medium' | 'low';
}

         â†“

// Processing
TwitterSyndicationResponse
  â†’ mediaDetails[]
    â†’ video_info.variants[]
      â†’ TwitterVideoVariant[]

         â†“

// Transform
processVideoVariants()
  â†’ ProcessedVideo[]

         â†“

// Output
interface ExtractionResult {
  success: boolean;
  media?: ExtractedTwitterMedia;
  error?: string;
  method: 'syndication' | 'html_parsing' | 'oembed';
}
```

---

**Legend:**

- âš¡ = Very Fast (< 500ms)
- ğŸ”¸ = Medium Speed (500ms - 1s)
- ğŸ¢ = Slow (> 1s)
- âœ“ = Works
- âœ— = Doesn't work
- â–“ = Time unit (~0.1s)
